name: æ¯æ—¥ã®è¨˜äº‹è‡ªå‹•ç”Ÿæˆ

on:
  schedule:
    # æ¯æ—¥æ—¥æœ¬æ™‚é–“ã®æœ7æ™‚ï¼ˆUTC 22:00ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 22 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install openai requests

      - name: è¨˜äº‹ã‚’ç”Ÿæˆ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          echo "=== è¨˜äº‹ç”Ÿæˆé–‹å§‹ ==="
          python scripts/generate_article.py

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãªã—"
          else
            git commit -m "ğŸ“ $(date +'%Y-%m-%d') ã®è¨˜äº‹ã‚’è¿½åŠ "
            git push
          fi

      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build

      - name: GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages

